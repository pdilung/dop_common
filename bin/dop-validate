#!/usr/bin/env ruby
#
# DOP COMMON Validator
#
require 'dop_common'
require 'optparse'
require 'yaml'

options = {}
option_parser = OptionParser.new do |opts|
  opts.banner  = "Usage: dop-validate [options] plan_file"

  options[:errors_only] = false
  opts.on("-e", "--errors-only", "Only print Errors and no warnings") do |v|
    options[:errors_only] = true
  end

  options[:include_dopi] = false
  opts.on("-d", "--include-dopi", "Include plugin validators from DOPi") do |v|
    options[:include_dopi] = true
  end

  opts.on( '-v', '--version', 'Show version of dop_common' ) do
    puts DopCommon::VERSION
    exit
  end

  opts.on( '-h', '--help', 'Display this screen' ) do
    puts opts
    exit
  end

end

begin option_parser.parse!
rescue OptionParser::InvalidOption => e
  puts e
  puts
  puts option_parser
  exit(-1)
end


plan_yaml = ARGV[0]

if plan_yaml.nil?
  puts option_parser
  exit(-1)
end

unless File.exists?(plan_yaml)
  puts "Error: plan file does not exists."
  puts
  puts option_parser
  exit(-1)
end

plan_hash = nil
begin
  plan_hash = YAML.load_file(plan_yaml)
rescue Exception => e
  puts "Error: plan file is not a valid yaml document."
  exit(-1)
end

plan = DopCommon::Plan.new(plan_hash)

if options[:include_dopi]
  begin
    require 'dopi'
  rescue Exception => e
    puts "Error: Could not load DOPi. Make sure you install the dopi gem"
  else
    plan = Dopi::Plan.new(plan)
  end
end

exit(plan.valid?)

