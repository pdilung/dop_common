infrastructure:
    management:
        type: rhev
        endpoint: https://rhev.example.com/api
        credentials:
            username: myuser
            password: mypass
        networks:
            rhevm:
                ip_pool:
                    from: 192.168.254.11
                    to: 192.168.254.245
                ip_netmask: 255.255.255.0
                ip_defgw: 192.168.254.254
            production:
                ip_pool:
                    from: 192.168.254.11
                    to: 192.168.254.245
                ip_netmask: 255.255.255.0
                ip_defgw: 192.168.254.254
        affinity_groups:
            clu-lab1ch-ag_1:
                positive: true
                enforce: true
                cluster: clu-lab1ch
            clu-lab1ch-ag_2:
                positive: true
                enforce: false
                cluster: clu-lab1ch
            clu-lab1ch-ag_3:
                positive: false
                enforce: true
                cluster: clu-lab1ch

    lamp:
        type: openstack
        endpoint: https://openstack.example.com/api
        credentials:
            username: myuser
            password: mypass
            provider_apikey: A4532FAA....
        networks:
            management:
                ip_pool:
                    from: 192.168.253.11
                    to: 192.168.253.245
                ip_netmask: 255.255.255.0
                ip_defgw: 192.168.253.254
            production:
                ip_pool:
                    from: 192.168.1.101
                    to: 192.168.1.245
                ip_netmask: 255.255.255.0
                ip_defgw: 192.168.1.254

nodes:
    mgt01.example.com:
        infrastructure: management
        infrastructure_properties:
            affinity_groups:
                - clu-lab1ch-ag_1
                - clu-lab1ch-ag_3
            keep_ha: true
        datacenter: lab1ch
        cluster: clu-lab1ch
        image: rhel6cloudinit
        interfaces:
            eth0:
                network: rhevm
                ip: 192.168.254.12
        credentials:
            root_ssh_keys:
                - key1
                - key2

    mssql01_mgt01:
        fqdn: mssql01.example.com
        infrastructure: management
        infrastructure_properties:
            keep_ha: true
        image: win12r1_64
        cores: 6
        memory: 64G
        storage: 128G
        interfaces:
            eth0:
                network: rhevm
                ip: 192.168.254.13
        disks:
            - name: db1
              pool: storage_pool3
              size: 256G
        credentials:
            root_password: a_password

    mysql01.example.com:
        infrastructure: lamp
        infrastructure_properties:
            keep_ha: true
        image: rhel6cloudinit
        flavor: medium
        interfaces:
            eth0:
                network: management
                ip: 192.168.253.25
            eth1:
                network: production
                ip: 192.168.1.102
                set_gateway: false
        disks:
            - name: rdo
              pool: storage_pool1
              size: 4000M
            - name: db1
              pool: storage_pool1
              size: 20G
        credentials:
            root_password: a_password

    web01.example.com:
        infrastructure: lamp
        infrastructure_properties:
            keep_ha: false
        image: rhel6
        flavor: small
        interfaces:
            eth0:
                network: management
                ip: 192.168.253.26
            eth1:
                network: production
                ip: dhcp
  
    web02.example.com:
        infrastructure: lamp
        infrastructure_properties:
            keep_ha: false
        image: rhel6
        flavor: medium
        interfaces:
            eth0:
                network: management
                ip: 192.168.253.27
            eth1:
                network: production
                ip: 192.168.1.103
                set_gateway: false

    haproxy01.example.com:
        infrastructure: lamp
        infrastructure_properties:
            keep_ha: true
        image: rhel6cloudinit
        flavor: small
        interfaces:
            eth0:
                network: management
                ip: 192.168.253.28
            eth1:
                network: production
                ip: dhcp

configuration:
    hosts:
        mysql01.example.com:
            my_role: mysql
        web01.example.com:
            my_role: httpd_basic
        web02.example.com:
            my_role: httpd_special
        haproxy01.example.com:
            my_role: haproxy
    roles:
        mysql:
            mysql::default_database:
                name: mydatabase
                user: myuser
                password: mypass

plan:
    max_in_flight: 2

steps:

    - name: 'Make sure we can login to all nodes'
      nodes: all
      command:
          plugin: ssh/wait_for_login
          plugin_timeout: 600

    - name: 'Install Puppet'
      nodes: all
      command:
          plugin: ssh/custom
          verify_commands:
              - plugin: ssh/file_exists
                file: /usr/bin/puppet
          exec: yum
          arguments: 'install puppet'
          expect_exit_codes: 0
          fail_on_warning: False
          parse_output:
              error:
                  - '^No package puppet available'

    - name: 'Initial Puppet run to configure puppet'
      nodes: all
      command:
          plugin: ssh/puppet_agent_run
          verify_commands:
              - plugin: ssh/file_contains
                file: /etc/puppet/puppet.conf
                pattern: puppet.example.com
          arguments:
              - '--server puppet.example.com'
              - '--environment production'
              - '--tags puppet::client'

    - name: 'Configure the MySQL server'
      nodes:
          - mysql01.example.com
      command: ssh/puppet_agent_run

    - name: 'Configure the Webservers'
      roles:
          - httpd_basic
          - httpd_special
      command: ssh/puppet_agent_run

    - name: 'Configure the HA Proxy'
      roles:
          - haproxy
      command: ssh/puppet_agent_run


